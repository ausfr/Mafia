<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mafia: Interactive Narrator</title>
    <style>
        :root {
            --bg: #0f0f0f;
            --card: #1a1a1a;
            --primary: #d32f2f;
            --secondary: #1976d2;
            --text: #e0e0e0;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body {
            font-family: 'Segoe UI', Roboto, sans-serif;
            background-color: var(--bg); color: var(--text);
            margin: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden;
        }

        /* --- HEADER --- */
        .header { padding: 15px; background: #000; text-align: center; border-bottom: 1px solid #333; }
        .header h1 { margin: 0; font-size: 1.2rem; letter-spacing: 3px; color: var(--primary); text-transform: uppercase; }

        /* --- SCREENS --- */
        .screen {
            flex: 1; display: none; flex-direction: column;
            padding: 20px; overflow-y: auto; animation: fadeIn 0.3s ease;
        }
        .screen.active { display: flex; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* --- UI ELEMENTS --- */
        .card { background: var(--card); padding: 20px; border-radius: 12px; border: 1px solid #333; margin-bottom: 15px; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 15px 0; }
        
        .p-btn {
            background: #252525; border: 1px solid #444; color: white;
            padding: 15px; border-radius: 8px; text-align: center; cursor: pointer;
        }
        .p-btn.selected { background: var(--primary); border-color: white; font-weight: bold; }
        .p-btn.dead { opacity: 0.3; text-decoration: line-through; pointer-events: none; }

        .btn {
            background: var(--primary); color: white; border: none; padding: 18px;
            border-radius: 10px; font-size: 1.1rem; font-weight: bold; width: 100%;
            cursor: pointer; box-shadow: 0 4px 0 #800; margin-top: 10px;
        }
        .btn:active { transform: translateY(2px); box-shadow: 0 2px 0 #800; }
        .btn-sec { background: var(--secondary); box-shadow: 0 4px 0 #0d47a1; }

        input[type="text"] {
            width: 100%; padding: 15px; border-radius: 8px; border: 1px solid #444;
            background: #222; color: white; font-size: 1rem; margin-bottom: 10px;
        }

        .role-tag { font-size: 2rem; color: var(--primary); font-weight: 900; margin: 10px 0; }
        .narrator-msg { font-style: italic; color: #888; text-align: center; margin: 10px 0; }
    </style>
</head>
<body>

    <div class="header"><h1>Mafia Narrator</h1></div>

    <div id="scr-setup" class="screen active">
        <div class="card">
            <h2>Players</h2>
            <div style="display:flex; gap:10px;">
                <input type="text" id="in-name" placeholder="Name" onkeydown="if(event.key==='Enter') addP()">
                <button class="btn" style="width:auto; margin:0;" onclick="addP()">+</button>
            </div>
            <div id="p-tags" style="display:flex; flex-wrap:wrap; gap:8px; margin-top:10px;"></div>
        </div>
        <div class="card">
            <h2>Special Roles</h2>
            <label style="display:block; margin:10px 0;"><input type="checkbox" id="chk-pol" checked> Police üëÆ</label>
            <label style="display:block; margin:10px 0;"><input type="checkbox" id="chk-doc" checked> Doctor üöë</label>
            <label style="display:block; margin:10px 0;"><input type="checkbox" id="chk-drk"> Drunkard üç∫</label>
        </div>
        <button class="btn" onclick="startGame()">Start Game</button>
    </div>

    <div id="scr-reveal" class="screen">
        <h2 id="rev-user" style="text-align:center;">Pass to Player</h2>
        <div class="card" style="text-align:center; min-height:200px; display:flex; flex-direction:column; justify-content:center;">
            <div id="rev-box" style="display:none;">
                <div id="rev-role" class="role-tag">ROLE</div>
                <p id="rev-desc">Description</p>
            </div>
        </div>
        <button id="btn-rev" class="btn" onclick="doReveal()">Reveal Role</button>
    </div>

    <div id="scr-pass" class="screen">
        <div style="flex:1; display:flex; flex-direction:column; justify-content:center; text-align:center;">
            <h2 id="pass-title">NIGHT</h2>
            <p id="pass-instruction" style="font-size:1.5rem;">Pass device to Mafia</p>
        </div>
        <button class="btn" onclick="openAction()">I am ready</button>
    </div>

    <div id="scr-action" class="screen">
        <h2 id="act-role-title" style="text-align:center; color:var(--primary);">MAFIA</h2>
        <p class="narrator-msg" id="act-voice-text">The Narrator is speaking...</p>
        <div id="act-grid" class="grid"></div>
        <button id="btn-confirm" class="btn" onclick="confirmAct()">Confirm Choice</button>
    </div>

    <div id="scr-day" class="screen">
        <h2 style="text-align:center;">MORNING</h2>
        <div class="card" id="day-report" style="font-size:1.2rem; text-align:center; border-left:5px solid var(--primary);">
            Reporting...
        </div>
        <div id="day-grid" class="grid"></div>
        <button class="btn btn-sec" onclick="voteOut()">Vote Someone Out (Trial)</button>
        <button class="btn" onclick="startNight()">Start Next Night</button>
    </div>

    <script>
        // --- DATA ---
        let players = JSON.parse(localStorage.getItem('mafia_names')) || [];
        let deck = []; // {name, role, alive:true}
        let nightLog = { kill: null, save: null };
        let queue = [];
        let qIdx = 0;
        const synth = window.speechSynthesis;

        // --- SETUP ---
        function addP() {
            let n = document.getElementById('in-name').value.trim();
            if(n) { players.push(n); document.getElementById('in-name').value=''; renderSetup(); }
        }
        function renderSetup() {
            document.getElementById('p-tags').innerHTML = players.map((p,i)=>`<div class="p-btn" style="padding:5px 10px;">${p} <span onclick="players.splice(${i},1);renderSetup()" style="color:red;">√ó</span></div>`).join('');
            localStorage.setItem('mafia_names', JSON.stringify(players));
        }
        renderSetup();

        function speak(txt, callback) {
            synth.cancel();
            let u = new SpeechSynthesisUtterance(txt);
            u.pitch = 0.8; u.rate = 0.9;
            u.onend = callback;
            synth.speak(u);
        }

        // --- GAME ENGINE ---
        function startGame() {
            if(players.length < 3) return alert("Need 3+ players");
            let roles = [];
            let mCount = Math.max(1, Math.floor(players.length/4));
            for(let i=0; i<mCount; i++) roles.push('Mafia');
            if(document.getElementById('chk-pol').checked) roles.push('Police');
            if(document.getElementById('chk-doc').checked) roles.push('Doctor');
            if(document.getElementById('chk-drk').checked) roles.push('Drunkard');
            while(roles.length < players.length) roles.push('Citizen');
            
            roles.sort(()=>Math.random()-0.5);
            deck = players.map((p,i)=>({name:p, role:roles[i], alive:true}));
            
            revIdx = 0;
            showScr('scr-reveal');
            prepRev();
        }

        // --- REVEAL ---
        let revIdx = 0;
        function prepRev() {
            if(revIdx >= deck.length) return startNight();
            document.getElementById('rev-user').innerText = `Pass to: ${deck[revIdx].name}`;
            document.getElementById('rev-box').style.display = 'none';
            document.getElementById('btn-rev').innerText = "Tap to Reveal";
            document.getElementById('btn-rev').onclick = () => {
                document.getElementById('rev-box').style.display = 'block';
                document.getElementById('rev-role').innerText = deck[revIdx].role;
                document.getElementById('rev-desc').innerText = getDesc(deck[revIdx].role);
                document.getElementById('btn-rev').innerText = "Hide & Next";
                document.getElementById('btn-rev').onclick = () => { revIdx++; prepRev(); };
            };
        }
        function getDesc(r) {
            if(r==='Mafia') return "Kill a citizen every night.";
            if(r==='Police') return "Investigate a player every night.";
            if(r==='Doctor') return "Save one player from death every night.";
            if(r==='Drunkard') return "Act suspicious. If you are voted out, you win!";
            return "Survive and vote out the Mafia.";
        }

        // --- NIGHT ENGINE ---
        function startNight() {
            nightLog = { kill: null, save: null };
            queue = [];
            qIdx = 0;
            if(deck.some(p=>p.role==='Mafia' && p.alive)) queue.push('Mafia');
            if(deck.some(p=>p.role==='Doctor' && p.alive)) queue.push('Doctor');
            if(deck.some(p=>p.role==='Police' && p.alive)) queue.push('Police');

            speak("It is now night. Everyone, go to sleep.", () => {
                nextInQueue();
            });
        }

        function nextInQueue() {
            if(qIdx >= queue.length) return resolveNight();
            let role = queue[qIdx];
            document.getElementById('pass-instruction').innerText = `Pass device to: ${role}`;
            showScr('scr-pass');
            speak(`${role}, wake up.`);
        }

        function openAction() {
            let role = queue[qIdx];
            document.getElementById('act-role-title').innerText = role;
            let prompt = "";
            if(role==='Mafia') prompt = "Mafia, choose your victim.";
            if(role==='Doctor') prompt = "Doctor, who are you protecting?";
            if(role==='Police') prompt = "Police, who do you want to investigate?";
            
            document.getElementById('act-voice-text').innerText = prompt;
            renderGrid('act-grid', true);
            showScr('scr-action');
            speak(prompt);
        }

        let selIdx = -1;
        function renderGrid(id, selectable) {
            const container = document.getElementById(id);
            container.innerHTML = '';
            selIdx = -1;
            deck.forEach((p, i) => {
                const b = document.createElement('div');
                b.className = `p-btn ${p.alive ? '' : 'dead'}`;
                b.innerText = p.name;
                if(selectable && p.alive) {
                    b.onclick = () => {
                        document.querySelectorAll('.p-btn').forEach(x=>x.classList.remove('selected'));
                        b.classList.add('selected');
                        selIdx = i;
                    };
                }
                container.appendChild(b);
            });
        }

        function confirmAct() {
            if(selIdx === -1) return;
            let role = queue[qIdx];
            let target = deck[selIdx];

            if(role==='Mafia') {
                nightLog.kill = selIdx;
                finishTurn();
            } else if(role==='Doctor') {
                nightLog.save = selIdx;
                finishTurn();
            } else if(role==='Police') {
                let isMafia = target.role === 'Mafia';
                let result = isMafia ? `This person is Mafia.` : `This person is a Citizen.`;
                speak(result, () => {
                    alert(result);
                    finishTurn();
                });
            }
        }

        function finishTurn() {
            speak(`${queue[qIdx]}, go back to sleep.`, () => {
                qIdx++;
                nextInQueue();
            });
        }

        // --- RESOLVE ---
        function resolveNight() {
            let deathName = null;
            if(nightLog.kill !== null && nightLog.kill !== nightLog.save) {
                deck[nightLog.kill].alive = false;
                deathName = deck[nightLog.kill].name;
            }

            showScr('scr-day');
            renderGrid('day-grid', false);
            
            let report = deathName ? `A tragedy occurred. ${deathName} was killed.` : `A miracle occurred. No one died last night.`;
            document.getElementById('day-report').innerText = report;
            
            speak(`Everyone, wake up. It is now morning. ${report}`);
            checkWin();
        }

        function voteOut() {
            let n = prompt("Enter the name of the player to eliminate:");
            let p = deck.find(x => x.name.toLowerCase() === n?.toLowerCase() && x.alive);
            if(!p) return alert("Player not found or already dead.");

            if(p.role === 'Drunkard') {
                speak(`The village has made a mistake! ${p.name} was the Drunken Idiot. He wins!`);
                alert(`${p.name} was the Drunkard! He wins the game!`);
                return location.reload();
            }

            p.alive = false;
            speak(`${p.name} has been eliminated.`);
            renderGrid('day-grid', false);
            checkWin();
        }

        function checkWin() {
            let maf = deck.filter(x=>x.role==='Mafia' && x.alive).length;
            let civ = deck.filter(x=>x.role!=='Mafia' && x.alive).length;

            if(maf === 0) {
                speak("The Mafia has been wiped out. Civilians win!");
                alert("Civilians Win!");
                location.reload();
            } else if(maf >= civ) {
                speak("The Mafia has overtaken the town. Mafia wins!");
                alert("Mafia Win!");
                location.reload();
            }
        }

        function showScr(id) {
            document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }
    </script>
</body>
</html>
