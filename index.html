<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#121212">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Mafia Master: Card Edition</title>
    <style>
        :root {
            --bg: #0d0d0d;
            --card-surface: #1a1a1a;
            --primary: #c62828;
            --secondary: #1565c0;
            --text: #ffffff;
            --accent: #ff8f00;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: var(--bg); color: var(--text);
            margin: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden;
        }

        .header { padding: 15px; background: #000; text-align: center; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center;}
        .header h1 { margin: 0; font-size: 1.1rem; color: var(--primary); text-transform: uppercase; letter-spacing: 3px; flex: 1;}
        .settings-btn { background: none; border: none; font-size: 1.5rem; cursor: pointer; padding-right: 15px; }

        .screen { flex: 1; display: none; flex-direction: column; padding: 20px; overflow-y: auto; }
        .screen.active { display: flex; }

        .card-ui { background: var(--card-surface); padding: 20px; border-radius: 12px; margin-bottom: 15px; border: 1px solid #333; box-shadow: 0 4px 10px rgba(0,0,0,0.5); }
        
        .btn {
            background: var(--primary); color: white; border: none; padding: 16px;
            border-radius: 10px; font-size: 1.1rem; font-weight: bold; width: 100%;
            cursor: pointer; margin-top: 10px; box-shadow: 0 4px 0 #7f0000;
            transition: all 0.1s;
        }
        .btn:active { transform: translateY(2px); box-shadow: 0 2px 0 #7f0000; }
        .btn-blue { background: var(--secondary); box-shadow: 0 4px 0 #0d47a1; }
        .btn-blue:disabled { background: #333; box-shadow: none; color: #666; cursor: not-allowed; }

        input[type="text"] {
            width: 100%; padding: 14px; border-radius: 8px; border: 1px solid #444;
            background: #252525; color: white; font-size: 1rem; margin-bottom: 10px; outline: none;
        }

        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .p-btn {
            background: #262626; padding: 15px 10px; border-radius: 8px; border: 2px solid #333;
            text-align: center; font-size: 1rem; cursor: pointer; color: #fff;
        }
        .p-btn.selected { border-color: var(--primary); background: #3d1a1a; font-weight: bold; }
        .p-btn.dead { opacity: 0.3; text-decoration: line-through; pointer-events: none; }

        .role-img { width: 160px; height: auto; border-radius: 8px; margin-bottom: 15px; border: 2px solid #444; }

        .setting-row { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #333; }
        input[type="range"] { width: 100px; accent-color: var(--primary); }
    </style>
</head>
<body>

    <div class="header">
        <h1>Mafia Master</h1>
        <button class="settings-btn" onclick="show('s-settings')">⚙️</button>
    </div>

    <div class="screen-container">
        
        <div id="s-setup" class="screen active">
            <div class="card-ui">
                <h2>Players</h2>
                <div style="display:flex; gap:10px;">
                    <input type="text" id="in-name" placeholder="Name" onkeydown="if(event.key==='Enter') addP()">
                    <button class="btn" style="width:auto; margin:0;" onclick="addP()">+</button>
                </div>
                <div id="list-p" style="display:flex; flex-wrap:wrap; gap:8px; margin-top:10px;"></div>
            </div>
            <div class="card-ui">
                <h2>Select Roles</h2>
                <div class="setting-row"><span>Police (Kings)</span> <input type="checkbox" id="c-pol" checked></div>
                <div class="setting-row"><span>Doctor (Queens)</span> <input type="checkbox" id="c-doc" checked></div>
                <div class="setting-row"><span>Drunkard (Joker)</span> <input type="checkbox" id="c-drk"></div>
            </div>
            <button id="btn-start" class="btn" onclick="startGame()">Deal Cards (0)</button>
        </div>

        <div id="s-settings" class="screen">
            <h2 style="text-align:center;">Narrator Settings</h2>
            <div class="card-ui">
                <div class="setting-row">
                    <span>Action Time</span>
                    <input type="range" id="set-action" min="5" max="40" value="15" oninput="updSet()">
                </div>
                <div style="text-align:right; font-size:0.8rem; color:var(--primary);" id="val-action">15s</div>
                
                <div class="setting-row">
                    <span>Start Delay</span>
                    <input type="range" id="set-start" min="3" max="15" value="8" oninput="updSet()">
                </div>
                <div style="text-align:right; font-size:0.8rem; color:var(--primary);" id="val-start">8s</div>
            </div>
            <button class="btn btn-blue" onclick="show('s-setup')">Back to Setup</button>
        </div>

        <div id="s-reveal" class="screen">
            <div class="card-ui" style="text-align:center; flex:1; display:flex; flex-direction:column; justify-content:center;">
                <p>Pass to:</p>
                <h1 id="rev-name" style="color:var(--primary); font-size:2.5rem;">Name</h1>
                <div id="rev-box" style="display:none; margin-top:20px;">
                    <img id="rev-img" class="role-img" src="">
                    <div id="rev-role" style="font-size:1.8rem; font-weight:900;">ROLE</div>
                    <p id="rev-desc" style="color:#aaa;"></p>
                </div>
            </div>
            <button id="btn-rev" class="btn" onclick="doReveal()">Reveal Card</button>
        </div>

        <div id="s-pass" class="screen">
            <div style="flex:1; display:flex; flex-direction:column; justify-content:center; text-align:center;">
                <h2 id="pass-title">Night Phase</h2>
                <p id="pass-txt" style="font-size:1.4rem;">Close your eyes...</p>
            </div>
            <button id="btn-night" class="btn" onclick="handleNightBtn()">Ready</button>
        </div>

        <div id="s-action" class="screen">
            <h2 id="act-role" style="text-align:center; color:var(--primary);">ROLE</h2>
            <div id="act-grid" class="grid"></div>
            <button id="btn-act" class="btn" onclick="confirmAction()">Confirm</button>
        </div>

        <div id="s-police" class="screen">
            <div style="flex:1; display:flex; flex-direction:column; justify-content:center; text-align:center;">
                <h1>Result</h1>
                <h1 id="pol-res" style="font-size:4rem;">???</h1>
            </div>
            <button class="btn" onclick="endTurn()">Back to Sleep</button>
        </div>

        <div id="s-day" class="screen">
            <h2 style="text-align:center;">Morning</h2>
            <div class="card-ui" id="day-log" style="font-weight:bold; text-align:center;"></div>
            <div id="day-grid" class="grid" style="margin-bottom:20px;"></div>
            <button id="btn-hang" class="btn btn-blue" onclick="openVote()">Vote to Hang (Once)</button>
            <button class="btn" onclick="setupNight()" style="background:#444;">End Day</button>
        </div>

        <div id="s-vote" class="screen">
            <h2 style="text-align:center;">Selection</h2>
            <div id="vote-grid" class="grid"></div>
            <button class="btn btn-blue" style="background:#444;" onclick="show('s-day')">Cancel</button>
        </div>

    </div>

    <script>
        // --- CONFIG & ASSETS ---
        const IMGS = {
            Mafia: "https://deckofcardsapi.com/static/img/AS.png",
            Police: "https://deckofcardsapi.com/static/img/KH.png",
            Doctor: "https://deckofcardsapi.com/static/img/QH.png",
            Drunk: "https://deckofcardsapi.com/static/img/0D.png",
            Citizen: "https://deckofcardsapi.com/static/img/2C.png"
        };

        let players = JSON.parse(localStorage.getItem('maf_app_p')) || [];
        let deck = [], tQueue = [], tIdx = 0, nightData = { kill: null, save: null }, hangedToday = false;
        let config = { action: 15000, start: 8000 };
        const synth = window.speechSynthesis;

        // --- SETUP ---
        function addP() {
            let n = document.getElementById('in-name').value.trim();
            if(n) { players.push(n); document.getElementById('in-name').value=''; renderList(); }
        }
        function renderList() {
            document.getElementById('list-p').innerHTML = players.map((p,i)=>`<div class="p-btn" style="padding:5px;">${p} <span onclick="remP(${i})" style="color:red;">×</span></div>`).join('');
            document.getElementById('btn-start').innerText = `Deal Cards (${players.length})`;
            localStorage.setItem('maf_app_p', JSON.stringify(players));
        }
        function remP(i) { players.splice(i,1); renderList(); }
        renderList();

        function updSet() {
            config.action = document.getElementById('set-action').value * 1000;
            config.start = document.getElementById('set-start').value * 1000;
            document.getElementById('val-action').innerText = document.getElementById('set-action').value + 's';
            document.getElementById('val-start').innerText = document.getElementById('set-start').value + 's';
        }

        // --- GAME START ---
        function startGame() {
            if(players.length < 3) return alert("Need 3+ players");
            let rls = [];
            let mCount = Math.max(1, Math.floor(players.length/4));
            for(let i=0; i<mCount; i++) rls.push({r:'Mafia', i:IMGS.Mafia, d:'Kill at night.'});
            if(document.getElementById('c-pol').checked) rls.push({r:'Police', i:IMGS.Police, d:'Check roles.'});
            if(document.getElementById('c-doc').checked) rls.push({r:'Doctor', i:IMGS.Doctor, d:'Save someone.'});
            if(document.getElementById('c-drk').checked) rls.push({r:'Drunkard', i:IMGS.Drunk, d:'Get hanged to win.'});
            while(rls.length < players.length) rls.push({r:'Citizen', i:IMGS.Citizen, d:'Find the Mafia.'});
            
            if(rls.length > players.length) return alert("Too many roles selected!");

            rls.sort(() => Math.random() - 0.5);
            deck = players.map((p, i) => ({ name: p, role: rls[i], alive: true }));
            
            revIdx = 0;
            show('s-reveal');
            prepRev();
        }

        // --- REVEAL ---
        let revIdx = 0;
        function prepRev() {
            if(revIdx >= deck.length) return setupNight();
            let p = deck[revIdx];
            document.getElementById('rev-name').innerText = p.name;
            document.getElementById('rev-box').style.display = 'none';
            document.getElementById('btn-rev').innerText = "Reveal My Card";
            document.getElementById('btn-rev').onclick = () => {
                document.getElementById('rev-box').style.display = 'block';
                document.getElementById('rev-img').src = p.role.i;
                document.getElementById('rev-role').innerText = p.role.r;
                document.getElementById('rev-desc').innerText = p.role.d;
                document.getElementById('btn-rev').innerText = "Hide & Next";
                document.getElementById('btn-rev').onclick = () => { revIdx++; prepRev(); };
            };
        }

        // --- NIGHT ---
        function setupNight() {
            nightData = { kill: null, save: null }; tQueue = []; tIdx = 0; hangedToday = false;
            if(deck.some(x=>x.role.r=='Mafia' && x.alive)) tQueue.push('Mafia');
            if(deck.some(x=>x.role.r=='Doctor' && x.alive)) tQueue.push('Doctor');
            if(deck.some(x=>x.role.r=='Police' && x.alive)) tQueue.push('Police');

            show('s-pass');
            document.getElementById('pass-txt').innerText = "Close your eyes...";
            document.getElementById('btn-night').innerText = "Start Night Cycle";
            document.getElementById('btn-night').onclick = () => {
                speak("It is night. Everyone go to sleep.", () => nextTurn());
            };
        }

        function nextTurn() {
            if(tIdx >= tQueue.length) return endNight();
            let r = tQueue[tIdx];
            show('s-pass');
            document.getElementById('pass-txt').innerText = `Pass to ${r}`;
            document.getElementById('btn-night').innerText = "I am ready";
            document.getElementById('btn-night').onclick = () => {
                show('s-action');
                document.getElementById('act-role').innerText = r;
                let p = `${r}, wake up. Choose your target.`;
                speak(p);
                renderG('act-grid', true);
            };
        }

        let sel = -1;
        function renderG(id, active) {
            let d = document.getElementById(id); d.innerHTML = ''; sel = -1;
            deck.forEach((p, i) => {
                let b = document.createElement('div');
                b.className = `p-btn ${p.alive ? '' : 'dead'}`;
                b.innerText = p.name;
                if(active && p.alive) b.onclick = () => {
                    document.querySelectorAll('.p-btn').forEach(x=>x.classList.remove('selected'));
                    b.classList.add('selected'); sel = i;
                };
                d.appendChild(b);
            });
        }

        function confirmAction() {
            if(sel === -1) return;
            let r = tQueue[tIdx];
            if(r == 'Mafia') nightData.kill = sel;
            if(r == 'Doctor') nightData.save = sel;
            if(r == 'Police') {
                let isM = deck[sel].role.r == 'Mafia';
                show('s-police');
                document.getElementById('pol-res').innerText = isM ? "MAFIA" : "CITIZEN";
                document.getElementById('pol-res').style.color = isM ? "red" : "green";
                speak("Result found.");
                return;
            }
            endTurn();
        }

        function endTurn() {
            speak(`${tQueue[tIdx]}, sleep.`, () => { tIdx++; nextTurn(); });
        }

        function endNight() {
            let v = null;
            if(nightData.kill !== null && nightData.kill !== nightData.save) {
                deck[nightData.kill].alive = false; v = deck[nightData.kill].name;
            }
            let m = v ? `${v} was killed.` : `No one died.`;
            document.getElementById('day-log').innerText = m;
            show('s-day');
            document.getElementById('btn-hang').disabled = false;
            renderG('day-grid', false);
            speak(`Morning. ${m}`);
            checkW();
        }

        // --- VOTE ---
        function openVote() {
            if(hangedToday) return;
            show('s-vote');
            let d = document.getElementById('vote-grid'); d.innerHTML = '';
            deck.forEach((p, i) => {
                if(!p.alive) return;
                let b = document.createElement('div'); b.className = 'p-btn'; b.innerText = p.name;
                b.onclick = () => {
                    if(confirm(`Hang ${p.name}?`)) {
                        if(p.role.r == 'Drunkard') { alert("Drunkard Wins!"); location.reload(); return; }
                        p.alive = false; hangedToday = true;
                        document.getElementById('btn-hang').disabled = true;
                        show('s-day'); renderG('day-grid', false);
                        speak(`${p.name} was hanged.`); checkW();
                    }
                };
                d.appendChild(b);
            });
        }

        function checkW() {
            let m = deck.filter(x=>x.role.r=='Mafia' && x.alive).length;
            let c = deck.filter(x=>x.role.r!='Mafia' && x.alive).length;
            if(m == 0) { alert("Civilians Win!"); location.reload(); }
            else if(m >= c) { alert("Mafia Wins!"); location.reload(); }
        }

        // --- UTILS ---
        function speak(t, cb) {
            synth.cancel(); let u = new SpeechSynthesisUtterance(t); u.rate = 0.9;
            if(cb) u.onend = cb; synth.speak(u);
        }
        function show(id) {
            document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }
    </script>
</body>
</html>
