<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mafia Game Master</title>
    <style>
        :root {
            --bg-color: #121212;
            --card-bg: #1e1e1e;
            --text-color: #e0e0e0;
            --accent-color: #d32f2f; /* Blood Red */
            --btn-text: #ffffff;
            --font-main: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        }

        * { box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: var(--font-main);
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            overflow-x: hidden;
        }

        h1 { color: var(--accent-color); font-size: 1.5rem; letter-spacing: 2px; text-transform: uppercase; margin-top: 15px; }
        
        .container {
            width: 100%;
            max-width: 480px; /* Mobile width optimized */
            padding: 20px;
            padding-bottom: 40px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            flex: 1;
        }

        /* --- PANELS (SCREENS) --- */
        .panel {
            display: none;
            flex-direction: column;
            gap: 15px;
            animation: slideUp 0.4s ease-out;
        }
        .panel.active { display: flex; }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* --- UI ELEMENTS --- */
        .card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
            border: 1px solid #333;
        }

        .input-group { display: flex; gap: 10px; }
        input[type="text"] {
            flex: 1;
            padding: 14px;
            border-radius: 8px;
            border: 1px solid #444;
            background: #252525;
            color: white;
            font-size: 1rem;
        }

        .player-tags { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 5px; }
        .tag {
            background: #333;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
            border: 1px solid #444;
            display: flex; align-items: center; gap: 8px;
        }
        .tag span { color: var(--accent-color); font-weight: bold; cursor: pointer; padding: 5px; }

        /* --- TOGGLES --- */
        .role-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #252525;
            padding: 12px 15px;
            border-radius: 8px;
            margin-bottom: 8px;
        }
        input[type="checkbox"] { transform: scale(1.4); accent-color: var(--accent-color); }

        /* --- GAMEPLAY CARDS --- */
        .game-card-img {
            width: 60%;
            max-width: 180px;
            height: auto;
            border-radius: 8px;
            margin: 0 auto 15px auto;
            display: block;
            box-shadow: 0 0 20px rgba(0,0,0,0.6);
        }
        
        .big-text {
            font-size: 1.4rem;
            text-align: center;
            line-height: 1.5;
            margin: 10px 0;
            min-height: 80px; /* Prevent jumpiness */
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .status-bar {
            height: 4px;
            background: #333;
            width: 100%;
            border-radius: 2px;
            margin: 15px 0;
            overflow: hidden;
        }
        .progress {
            height: 100%;
            background: var(--accent-color);
            width: 0%;
            transition: width 0.1s linear;
        }

        /* --- BUTTONS --- */
        button {
            background: var(--accent-color);
            color: white;
            border: none;
            padding: 16px;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            width: 100%;
            touch-action: manipulation;
            transition: transform 0.1s, opacity 0.2s;
        }
        button:active { transform: scale(0.98); opacity: 0.8; }
        button.secondary { background: #444; margin-top: 10px; font-size: 1rem; }
        button:disabled { background: #555; cursor: not-allowed; opacity: 0.5; }

        .hidden { display: none !important; }
    </style>
</head>
<body>

    <h1>Mafia Moderator</h1>

    <div class="container">
        
        <div id="screen-setup" class="panel active">
            <div class="card">
                <h3 style="margin-top:0">Players</h3>
                <div class="input-group">
                    <input type="text" id="player-input" placeholder="Add Name (e.g. Sarah)" onkeydown="if(event.key==='Enter') addPlayer()">
                    <button onclick="addPlayer()" style="width: auto;">+</button>
                </div>
                <div id="player-list" class="player-tags"></div>
            </div>

            <div class="card">
                <h3 style="margin-top:0">Special Roles</h3>
                <div class="role-row">
                    <label>Mafia (Aces)</label>
                    <input type="checkbox" checked disabled>
                </div>
                <div class="role-row">
                    <label>Police (Kings)</label>
                    <input type="checkbox" id="role-police" checked>
                </div>
                <div class="role-row">
                    <label>Doctor (Queens)</label>
                    <input type="checkbox" id="role-doctor" checked>
                </div>
                <div class="role-row">
                    <label>Mayor (x2 Vote)</label>
                    <input type="checkbox" id="role-mayor">
                </div>
                <div class="role-row">
                    <label>Drunkard</label>
                    <input type="checkbox" id="role-drunk">
                </div>
            </div>

            <button onclick="startGameSetup()">Deal Cards & Start</button>
            <button class="secondary" onclick="resetData()">Reset Everything</button>
        </div>

        <div id="screen-reveal" class="panel">
            <h2 style="text-align: center;">Identity Phase</h2>
            <div class="card" style="text-align: center;">
                <h3 id="pass-instruction" style="color: var(--accent-color);">Pass to Player</h3>
                
                <div id="secret-card-area" class="hidden">
                    <img id="card-img" class="game-card-img" src="" alt="Card">
                    <h2 id="card-role" style="margin: 5px 0;">ROLE</h2>
                    <p id="card-desc" style="color: #aaa; font-style: italic;">Description</p>
                </div>

                <div style="height: 20px;"></div> <button id="btn-reveal" onclick="handleRevealClick()">Reveal Identity</button>
            </div>
        </div>

        <div id="screen-game" class="panel">
            <div class="card">
                <h4 style="text-align:center; color:#777; margin:0;" id="game-phase-label">NIGHT PHASE</h4>
                
                <div class="big-text" id="narrator-text">
                    Ready to start...
                </div>

                <div class="status-bar"><div class="progress" id="progress-bar"></div></div>

                <button id="btn-action" onclick="runGameStep()">Start Night</button>
            </div>
            
            <button class="secondary" onclick="location.reload()">End Game / New Round</button>
        </div>

    </div>

    <script>
        // --- CONFIG ---
        const SPEECH_RATE = 0.9;
        const SPEECH_PITCH = 0.8; // Deep voice
        const PHASE_WAIT_TIME = 8000; // Time (ms) given to Mafia/Police to act before "Go to sleep"
        
        // --- ASSETS ---
        const IMGS = {
            ACE: "https://deckofcardsapi.com/static/img/AS.png",
            KING: "https://deckofcardsapi.com/static/img/KH.png",
            QUEEN: "https://deckofcardsapi.com/static/img/QH.png",
            JACK: "https://deckofcardsapi.com/static/img/JC.png",
            JOKER: "https://deckofcardsapi.com/static/img/0D.png", 
            CIVILIAN: "https://deckofcardsapi.com/static/img/2C.png" // Generic civilian
        };

        // --- STATE ---
        let players = JSON.parse(localStorage.getItem('mafia_players')) || [];
        let deck = [];
        let gameQueue = [];
        let currentStep = 0;
        let isSpeaking = false;
        let synth = window.speechSynthesis;

        // --- INITIALIZATION ---
        function renderPlayers() {
            const list = document.getElementById('player-list');
            list.innerHTML = players.map((p, i) => 
                `<div class="tag">${p} <span onclick="removePlayer(${i})">Ã—</span></div>`
            ).join('');
            localStorage.setItem('mafia_players', JSON.stringify(players));
        }
        renderPlayers();

        function addPlayer() {
            const input = document.getElementById('player-input');
            const name = input.value.trim();
            if (name) {
                players.push(name);
                input.value = '';
                renderPlayers();
            }
        }

        function removePlayer(i) {
            players.splice(i, 1);
            renderPlayers();
        }

        function resetData() {
            if(confirm("Clear all names?")) {
                players = [];
                renderPlayers();
            }
        }

        // --- GAME SETUP & DEALING ---
        function startGameSetup() {
            if (players.length < 3) return alert("Need 3+ players.");

            // 1. Roles
            const roles = {
                police: document.getElementById('role-police').checked,
                doctor: document.getElementById('role-doctor').checked,
                mayor: document.getElementById('role-mayor').checked,
                drunk: document.getElementById('role-drunk').checked
            };

            // 2. Build Deck
            let cards = [];
            const mafiaCount = Math.max(1, Math.floor(players.length / 4));
            
            for(let i=0; i<mafiaCount; i++) cards.push({ role: "Mafia", img: IMGS.ACE, desc: "Wake up at night. Eliminate one player." });
            if(roles.police) cards.push({ role: "Police", img: IMGS.KING, desc: "Wake up at night. Check if one player is Mafia." });
            if(roles.doctor) cards.push({ role: "Doctor", img: IMGS.QUEEN, desc: "Wake up at night. Save one player." });
            if(roles.mayor) cards.push({ role: "Mayor", img: IMGS.JACK, desc: "Your vote counts as x2 during the day." });
            if(roles.drunk) cards.push({ role: "Drunkard", img: IMGS.JOKER, desc: "You win if you get voted out." });

            while(cards.length < players.length) {
                cards.push({ role: "Civilian", img: IMGS.CIVILIAN, desc: "Sleep at night. Vote during the day." });
            }

            // 3. Shuffle
            cards.sort(() => Math.random() - 0.5);
            
            // 4. Assign
            deck = players.map((p, i) => ({ name: p, card: cards[i] }));

            // 5. Start Reveal
            switchPanel('screen-reveal');
            setupReveal(0);
        }

        // --- REVEAL LOGIC ---
        let revealIdx = 0;
        function setupReveal(idx) {
            revealIdx = idx;
            if (idx >= deck.length) {
                // Done
                initGameLoop();
                return;
            }
            const p = deck[idx];
            document.getElementById('pass-instruction').innerText = `Pass device to ${p.name}`;
            document.getElementById('secret-card-area').classList.add('hidden');
            document.getElementById('btn-reveal').innerText = "Reveal My Role";
            document.getElementById('btn-reveal').onclick = () => {
                // Show Card
                document.getElementById('secret-card-area').classList.remove('hidden');
                document.getElementById('card-img').src = p.card.img;
                document.getElementById('card-role').innerText = p.card.role;
                document.getElementById('card-desc').innerText = p.card.desc;
                
                // Change Button
                const btn = document.getElementById('btn-reveal');
                btn.innerText = "Hide & Pass";
                btn.onclick = () => setupReveal(idx + 1);
            };
        }

        // --- CORE GAME LOOP (REFINED) ---
        function initGameLoop() {
            switchPanel('screen-game');
            buildGameQueue();
            updateGameUI();
        }

        function buildGameQueue() {
            // Check active roles in deck to decide prompts
            const hasRole = (r) => deck.some(d => d.card.role === r);

            gameQueue = [];

            // NIGHT START
            gameQueue.push({
                type: 'auto',
                text: "It is now Night. Everyone, go to sleep.",
                action: null
            });

            // MAFIA (Always present)
            gameQueue.push({
                type: 'timed_phase',
                role: 'Mafia',
                startText: "Mafia, wake up. Choose your target.",
                endText: "Mafia, go back to sleep.",
                duration: PHASE_WAIT_TIME
            });

            // DOCTOR
            if (hasRole('Doctor')) {
                gameQueue.push({
                    type: 'timed_phase',
                    role: 'Doctor',
                    startText: "Doctor, wake up. Who are you saving?",
                    endText: "Doctor, go back to sleep.",
                    duration: PHASE_WAIT_TIME
                });
            }

            // POLICE
            if (hasRole('Police')) {
                gameQueue.push({
                    type: 'timed_phase',
                    role: 'Police',
                    startText: "Police, wake up. Investigate someone.",
                    endText: "Police, go back to sleep.",
                    duration: PHASE_WAIT_TIME
                });
            }

            // MORNING
            gameQueue.push({
                type: 'manual',
                text: "Everyone wake up! It is morning.",
                btnText: "Start Discussion (5m)"
            });

            // DAY CYCLE
            gameQueue.push({
                type: 'timer',
                text: "Discuss: Who is the Mafia?",
                duration: 300 // 5 mins
            });

            gameQueue.push({
                type: 'manual',
                text: "Time's up. Accused, defend yourself.",
                btnText: "Start Vote"
            });

            gameQueue.push({
                type: 'manual',
                text: "3... 2... 1... VOTE!",
                btnText: "Next Night"
            });
        }

        function updateGameUI() {
            if (currentStep >= gameQueue.length) {
                currentStep = 0; // Loop back to night
            }

            const step = gameQueue[currentStep];
            const txt = document.getElementById('narrator-text');
            const btn = document.getElementById('btn-action');
            const phaseLabel = document.getElementById('game-phase-label');

            // Reset UI
            document.getElementById('progress-bar').style.width = '0%';
            btn.disabled = false;

            // Logic based on step type
            if (step.type === 'timed_phase') {
                phaseLabel.innerText = "NIGHT PHASE";
                txt.innerText = `${step.role} Phase`;
                btn.innerText = `Run ${step.role} Turn`;
                btn.onclick = () => runTimedPhase(step);
            } 
            else if (step.type === 'auto') {
                phaseLabel.innerText = "NIGHT START";
                txt.innerText = step.text;
                btn.innerText = "Announce & Continue";
                btn.onclick = () => {
                    speak(step.text, () => {
                        currentStep++;
                        updateGameUI();
                    });
                };
            }
            else if (step.type === 'manual') {
                phaseLabel.innerText = "DAY PHASE";
                txt.innerText = step.text;
                btn.innerText = step.btnText || "Next";
                btn.onclick = () => {
                    speak(step.text, () => {
                        // For vote/end logic, we just move next after speaking
                        currentStep++;
                        updateGameUI();
                    });
                };
            }
            else if (step.type === 'timer') {
                phaseLabel.innerText = "DISCUSSION";
                txt.innerText = "Discussion Timer";
                btn.innerText = "Start 5 Min Timer";
                btn.onclick = () => {
                    btn.disabled = true;
                    runVisualTimer(step.duration, () => {
                        speak("Time is up.", () => {
                            currentStep++;
                            updateGameUI();
                        });
                    });
                }
            }
        }

        // --- LOGIC FOR "LESS CLICKS" (Timed Phase) ---
        function runTimedPhase(step) {
            const btn = document.getElementById('btn-action');
            const txt = document.getElementById('narrator-text');
            
            btn.disabled = true; // Prevent double clicks
            btn.innerText = "Role Active...";

            // 1. Show text & Speak Start
            txt.innerText = step.startText;
            speak(step.startText, () => {
                
                // 2. Start Visual Countdown (Silence)
                runVisualTimer(step.duration / 1000, () => {
                    
                    // 3. Show text & Speak End
                    txt.innerText = step.endText;
                    speak(step.endText, () => {
                        
                        // 4. Auto Advance
                        currentStep++;
                        updateGameUI();
                    });
                });
            });
        }

        // --- UTILS ---
        function speak(text, callback) {
            // Cancel any current speech
            synth.cancel();
            
            const utter = new SpeechSynthesisUtterance(text);
            utter.pitch = SPEECH_PITCH;
            utter.rate = SPEECH_RATE;
            
            utter.onend = () => {
                if(callback) callback();
            };
            
            synth.speak(utter);
        }

        function runVisualTimer(seconds, onComplete) {
            const bar = document.getElementById('progress-bar');
            bar.style.transition = `width ${seconds}s linear`;
            
            // Force reflow
            void bar.offsetWidth; 
            
            bar.style.width = '100%';

            setTimeout(() => {
                bar.style.transition = 'none';
                bar.style.width = '0%';
                if(onComplete) onComplete();
            }, seconds * 1000);
        }

        function switchPanel(id) {
            document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

    </script>
</body>
</html>
